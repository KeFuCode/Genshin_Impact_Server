Genshin_Impact_Server
# 基础模块
## 0 文件结构
1. bin 文件夹
   - csvs 文件夹：放入配置表
   - 编译后的执行文件
2. go.mod
   包依赖管理
3. main.go
   程序的入口

## 1 基础模块
玩家从客户端登陆后，首先拿到的就是基础信息。
这个模块对应数据库中的一张表

UID 对每个玩家是唯一确定的

基础模块内容：
1. UID
2. 头像，名片
3. 签名
4. 名字
5. 冒险等级 冒险阅读
6. 世界等级 冷却时间：时间用 int64 存储
7. 生日
8. 展示阵容 展示名片

> 隐藏内容
1. 账号状态：使用 int 保存（不用 bool ），方便后续扩展。 
2. 管理员状态

## 2 模块关系
Player 作为最上层模块，接收到 Client 发送的消息后，调用 ModPlayer 内置方法。

## 3 名字验证
描述：名字验证
1. 英文名：字符格式多样，一般不做处理。
2. 中文名：违规中文名组合多种多样，防不胜防。直接写验证条件，无法穷尽，对服务器要求高。
   - 做法1：调用 HTTP 地址接口，进行外部验证。
     - 优点：对服务器压力小。
     - 缺点： 依赖外部验证服务器的安全性、稳定性。
   - 做法2（常用）：设置违禁词库，并提供更新方法。

例子：ManageBanWord 名字验证

描述：管理类与玩家类区别
玩家连接客户端之后，玩家线程被动创建。公共管理类，需要 server 启动后主动创建。
例子：单例模式实现管理类 管理类与玩家类区别

## 4 定时器功能
增加一个定时器，实现扩充禁用词。

描述：定时器作用
定时器给行为赋予了时间维度，每隔相同时间，就会触发一次行为。
例子：Run() 定时器作用
```go
func (self *ManageBanWord) Run() {
	triker := time.NewTicker(time.Second * 1)
	for {
		select {
		case <-triker.C:
			fmt.Println(time.Now().Unix())
		}
	}
}
```

## 5 启动协议 
将定时器 Run() 以协程 `go Run()` 的形式启动，可以不干扰主程序的运行。
否则程序会从 Run() 进入死循环，无法进入主程序后续逻辑。

## 6 配置基础词库  
一般策划将 EXCEL 表提交给程序，程序将 EXCEL 表转换为 CSV/Json 格式的内容。
Json 格式更像一个 map ，CSV 格式更像数组。两者可以互相转化，关键取决于服务器内部使用什么数据结构。

配置文件会在程序运行之后，初始化至内存中。init() 函数在初次调用 package 是，会自动执行。

## 7 人物等级和经验
### 7.1 配置原始数据
utils 中放入处理原始数据的脚本代码，方便将 CSV 文件载入内存。
### 7.2 人物升级方法
internal function: `func (self *ModPlayer) AddExp(exp int)` 
不能从客户端调用，只有服务器可以调用，当玩家进行某些行为（杀怪、副本、探索等），服务器根据情况，为玩家增加经验值。

## 8 完成任务
完成突破任务，人物等级才能继续提升。
map 查找效率很高，但是多线程中如果不加锁，很容易崩溃。

添加 ModUniqueTask , 用于玩家突破升级的验证条件。

> 完成任务的功能，是服务器内置功能，为了防止玩家在客户端反复刷资源。
## 9 多线程锁和 map
为了保证数据的安全性，在内存中的数据，同一时间不能多个线程共同操作。
当发生多个线程同时读写内存中同样数据时，主线程会发生异常，产生的结果是服务器崩溃，属于严重的安全事故。
给读/写操作加锁，虽然保证了数据的安全性，但是对服务器性能影响很大（3倍左右的差距）。

> 锁的基础理论与实际业务中的冲突  

map 的时间复杂度 O(1) ， 由于 map 的性能好，实际生产中经常使用 map ， 那么如何保证数据安全的同时，不降低服务器性能？
1. 改变设计模式，将多个线程降为一个线程，将多把锁降为一个锁。
   游戏中发放奖励，通常是通过邮件完成，而不是直接向玩家的背包中添加。直接向玩家背包中添加，若玩家在线，则背包中的数据面临同时读写，需要大量的锁才能保证背包数据安全。改变为邮件之后，是玩家通过领取邮件，自行将奖励写入背包，因此只需要为邮件系统加锁，不必为每个背包加锁。
2. 对于只读的数据，即使使用map，也不会影响数据安全性。
   配置表中的 `var ConfigUniqueTaskMap map[int]*ConfigUniqueTask` 是 map 类型，但是配置表不需要修改，只有读操作。不管多少线程去读，也不会导致数据不一致。 
## 10 世界等级
实现主动降低世界等级，恢复原来世界等级接口。两者都由玩家触发，是外部接口。
## 11 设置生日
Golang 中 `time.Now()` 获取的是系统本地时区对应的时间，可以直接使用，不需要额外时区转换。
## 12 展示名片
基础模块简化为三个部分：展示阵容，展示名片和封禁状态。
基础模块做完之后，就可以做登录模块。

客户端容易被修改，服务端需要验证客户端发送过来的多参数是否合法。只有合法的数据才被接收。

对于 `map[int]int` 可以通过 `v, ok := map[int]` 访问 map 中的值，其中 v 是获取的值，ok 是 bool 值，表示 map 中是否存在该键对应的值（存在返回 true，否则为 false ）。